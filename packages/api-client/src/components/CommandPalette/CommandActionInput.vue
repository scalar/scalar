<script setup lang="ts">
import { computed, nextTick, onMounted, ref } from 'vue'

const props = defineProps<{
  modelValue?: string
  placeholder?: string
}>()

const emit = defineEmits<{
  (e: 'update:modelValue', v: string): void
  (e: 'onDelete', event: KeyboardEvent): void
}>()

defineOptions({ inheritAttrs: false })

const input = ref<HTMLInputElement | null>(null)
onMounted(() => nextTick(() => input.value?.focus()))

const model = computed<string>({
  get: () => props.modelValue ?? '',
  set: (v) => emit('update:modelValue', v),
})

/** Re-emits enter as a submit event for the form  */
function handleEnter(event: KeyboardEvent) {
  if (event.shiftKey || !event.target) return
  event.preventDefault()
  const target = event.target as HTMLTextAreaElement
  const submitEvent = new Event('submit', { cancelable: true })
  target.form?.dispatchEvent(submitEvent)
}

/** Emits a back event if the input is empty */
function handleBack(event: KeyboardEvent) {
  if (model.value !== '') return
  event.preventDefault()
  event.stopPropagation()
  emit('onDelete', event)
}
</script>
<template>
  <textarea
    ref="input"
    v-model="model"
    class="border-none outline-none flex-1 w-full pl-8 text-sm min-h-8 py-1.5 resize-none"
    :placeholder="props.placeholder"
    wrap="hard"
    v-bind="$attrs"
    @keydown.delete="handleBack($event)"
    @keydown.enter="handleEnter($event)" />
</template>
