name: CI

# This workflow runs on:
# 1. Push events to the main branch
# 2. Pull request events
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch: null
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-base-ci
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
env:
  # Exclude these packages from turbo as they are handled by dedicated jobs
  TURBO_FLAGS: '--concurrency=100% --filter "!./integrations/{java,rust,dotnet,docker,fastapi,django-ninja}/**" --filter "!./projects/proxy-scalar-com/**"'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
jobs:
  # Initial build.
  # We only build the packages and integrations as everything else depends on them
  # turbo is cached to sticky disk and pnpm is cached in the standard actions cache
  build:
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './{packages,integrations}/**'
      - name: Copy and rename standalone.js to scalar.js
        run: |
          mkdir -p temp-artifacts
          cp packages/api-reference/dist/browser/standalone.js temp-artifacts/scalar.js
      - name: Upload scalar.js artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: scalar-js
          path: temp-artifacts/scalar.js
          retention-days: 3
      - name: Upload mock server docker entrypoint artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: mock-server-docker-entrypoint
          path: packages/mock-server/docker/dist/docker-entrypoint.js
          retention-days: 3
      - if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        name: Upload webpack stats to RelativeCI
        uses: relative-ci/agent-action@1707825cbfcc7452b2913d273414705415ae64d4 # v3
        with:
          key: ${{ secrets.RELATIVE_CI_KEY }}
          token: ${{ secrets.GITHUB_TOKEN }}
          webpackStatsFile: ./packages/api-reference/dist/browser/webpack-stats.json

  check-changes:
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      dotnet_changed: ${{ steps.set-outputs.outputs.dotnet_changed }}
      java_changed: ${{ steps.set-outputs.outputs.java_changed }}
      fastapi_changed: ${{ steps.set-outputs.outputs.fastapi_changed }}
      django_ninja_changed: ${{ steps.set-outputs.outputs.django_ninja_changed }}
      rust_changed: ${{ steps.set-outputs.outputs.rust_changed }}
      docker_changed: ${{ steps.set-outputs.outputs.docker_changed }}
      aspnetcore_package_changed: ${{ steps.set-outputs.outputs.aspnetcore_package_changed }}
      aspire_package_changed: ${{ steps.set-outputs.outputs.aspire_package_changed }}
      fastapi_package_changed: ${{ steps.set-outputs.outputs.fastapi_package_changed }}
      django_ninja_package_changed: ${{ steps.set-outputs.outputs.django_ninja_package_changed }}
      rust_package_changed: ${{ steps.set-outputs.outputs.rust_package_changed }}
      java_package_changed: ${{ steps.set-outputs.outputs.java_package_changed }}
      docker_package_changed: ${{ steps.set-outputs.outputs.docker_package_changed }}
      mock_server_docker_package_changed: ${{ steps.set-outputs.outputs.mock_server_docker_package_changed }}
      icons_changed: ${{ steps.set-outputs.outputs.icons_changed }}
      galaxy_changed: ${{ steps.set-outputs.outputs.galaxy_changed }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Check whether integration files were modified
        id: changed-integration-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            dotnet_integration:
              - integrations/dotnet/**
            java_integration:
              - integrations/java/**
            fastapi_integration:
              - integrations/fastapi/**
            rust_integration:
              - integrations/rust/**
            docker_integration:
              - integrations/docker/**
            django_ninja_integration:
              - integrations/django-ninja/**

      - name: Check whether packages files were modified
        id: changed-packages-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            icons_changed:
              - packages/icons/**
              - packages/components/src/components/ScalarIcon/**
            galaxy_changed:
              - packages/galaxy/**

      - name: Check whether integration package.json files were modified
        id: changed-package-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            aspnetcore_package:
              - integrations/dotnet/aspnetcore/package.json
            aspire_package:
              - integrations/dotnet/aspire/package.json
            fastapi_package:
              - integrations/fastapi/package.json
            django_ninja_package:
              - integrations/django-ninja/package.json
            rust_package:
              - integrations/rust/package.json
            java_package:
              - integrations/java/package.json
            docker_package:
              - integrations/docker/package.json
            mock_server_docker_package:
              - packages/mock-server/docker/package.json

      - name: Set job outputs
        id: set-outputs
        run: |
          echo "dotnet_changed=${{ steps.changed-integration-files.outputs.dotnet_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "java_changed=${{ steps.changed-integration-files.outputs.java_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "fastapi_changed=${{ steps.changed-integration-files.outputs.fastapi_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "django_ninja_changed=${{ steps.changed-integration-files.outputs.django_ninja_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "rust_changed=${{ steps.changed-integration-files.outputs.rust_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "docker_changed=${{ steps.changed-integration-files.outputs.docker_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "aspnetcore_package_changed=${{ steps.changed-package-files.outputs.aspnetcore_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "aspire_package_changed=${{ steps.changed-package-files.outputs.aspire_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "fastapi_package_changed=${{ steps.changed-package-files.outputs.fastapi_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "django_ninja_package_changed=${{ steps.changed-package-files.outputs.django_ninja_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "rust_package_changed=${{ steps.changed-package-files.outputs.rust_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "java_package_changed=${{ steps.changed-package-files.outputs.java_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "docker_package_changed=${{ steps.changed-package-files.outputs.docker_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "mock_server_docker_package_changed=${{ steps.changed-package-files.outputs.mock_server_docker_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "icons_changed=${{ steps.changed-packages-files.outputs.icons_changed_any_changed }}" >> $GITHUB_OUTPUT
          echo "galaxy_changed=${{ steps.changed-packages-files.outputs.galaxy_changed_any_changed }}" >> $GITHUB_OUTPUT

  format:
    if: github.event_name == 'pull_request'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
          # prettier and biome versions are pinned in package.json
          cache-dependency-path: 'package.json'
      # Install only root dependencies
      - name: Install dev dependencies
        run: pnpm install --filter .
      - name: Lint code
        run: pnpm lint:check
      - name: Check formatting
        run: pnpm format:check

  lint-icons:
    if: needs.check-changes.outputs.icons_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 15
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Lint Component Library Icons
        run: pnpm --filter components lint:icons
      - name: Lint Icon Library Icons
        run: pnpm --filter icons lint:icons

  types:
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Node
        uses: ./.github/actions/setup-node
      - name: Install dependencies
        run: pnpm install
      - name: Check types
        run: pnpm turbo ${{ env.TURBO_FLAGS }} types:check

  knip:
    if: github.event_name == 'pull_request'
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './{packages,integrations}/**'
      - name: Knip
        run: pnpm lint:knip

  test-packages:
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        shard-index: [1, 2]
        shard-total: [2]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: './packages/**'
      - name: Start test servers
        run: pnpm script run test-servers & pnpm script wait -p 5051 5052
        timeout-minutes: 1
      - name: Run tests
        run: pnpm vitest packages/* --silent --shard=${{ matrix.shard-index }}/${{ matrix.shard-total }}

  test-integrations:
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2204
    container:
      image: scalarapi/playwright-runner:1.56.0
      options: --privileged
      env:
        VM_ID: ${{ env.VM_ID }}
        GITHUB_REPO_NAME: ${{ env.GITHUB_REPO_NAME }}
        BLACKSMITH_STICKYDISK_TOKEN: ${{ env.BLACKSMITH_STICKYDISK_TOKEN }}
        BLACKSMITH_INSTALLATION_MODEL_ID: ${{ env.BLACKSMITH_INSTALLATION_MODEL_ID }}
        BLACKSMITH_REGION: ${{ env.BLACKSMITH_REGION }}
    env:
      HOME: '/root'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: './integrations/**'
      - name: Run tests
        run: pnpm vitest integrations/* --silent
        # For now we will integrate the E2E tests with the integrations tests as they are quite fast and this avoids another job.
      - name: Run e2e tests
        run: pnpm --filter @scalar/nuxt test:e2e

  test-proxy-server:
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: projects/proxy-scalar-com/go.mod
          cache: false
      - name: Run tests for the proxy server (Go)
        run: cd projects/proxy-scalar-com && go test -v

  test-e2e-api-reference:
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2204
    container:
      image: scalarapi/playwright-runner:1.56.0
      options: --privileged
      env:
        VM_ID: ${{ env.VM_ID }}
        GITHUB_REPO_NAME: ${{ env.GITHUB_REPO_NAME }}
        BLACKSMITH_STICKYDISK_TOKEN: ${{ env.BLACKSMITH_STICKYDISK_TOKEN }}
        BLACKSMITH_INSTALLATION_MODEL_ID: ${{ env.BLACKSMITH_INSTALLATION_MODEL_ID }}
        BLACKSMITH_REGION: ${{ env.BLACKSMITH_REGION }}
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: '@scalar/api-reference...'
      - name: Generate new DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV" && echo $DEPLOY_ID
      - name: Run e2e tests (@scalar/api-reference)
        run: pnpm --filter api-reference test:e2e:ci
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Deploy Playwright Report to Netlify
        run: |
          pnpx netlify deploy --dir "./packages/api-reference/playwright-report" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS_SNAPSHOTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --alias=${{env.DEPLOY_ID}}
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Add Netlify Playwright Report URL to the PR
        uses: daun/playwright-report-summary@93883773b4f4f0951d8bcdb780c6443ca51eaf7b # v3
        with:
          comment-title: 'Scalar References End to End Test Results'
          report-url: https://${{env.DEPLOY_ID}}--scalar-snapshots.netlify.app
          report-file: packages/api-reference/playwright-results.json
          report-tag: test-references-e2e
          footer: |
            > [!IMPORTANT]
            > These tests include snapshots that may need to be updated if there are intentional changes to the UI components. To update the snapshots run `pnpm test:e2e:update` in `packages/api-reference` and commit the changes.

  test-e2e-scalar-app:
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    container:
      image: scalarapi/playwright-runner:1.56.0
      options: --privileged
      env:
        VM_ID: ${{ env.VM_ID }}
        GITHUB_REPO_NAME: ${{ env.GITHUB_REPO_NAME }}
        BLACKSMITH_STICKYDISK_TOKEN: ${{ env.BLACKSMITH_STICKYDISK_TOKEN }}
        BLACKSMITH_INSTALLATION_MODEL_ID: ${{ env.BLACKSMITH_INSTALLATION_MODEL_ID }}
        BLACKSMITH_REGION: ${{ env.BLACKSMITH_REGION }}
    permissions:
      contents: read
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: 'scalar-app...'
      - name: Check whether the appFiles are there
        run: ls -R ./projects/scalar-app/dist
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
      - name: Run e2e tests (scalar-app)
        run: pnpm --filter scalar-app test:e2e
        env:
          DEBUG: pw:browser*
          DISPLAY: ':99'
      - if: failure()
        name: Show stack traces and debug info
        working-directory: playwright
        run: |
          echo "=== Playwright Logs ==="
          cat ~/.cache/ms-playwright/browser_logs/*.log || true

          echo "=== Test Results ==="
          ls -la test-results/ || true

          echo "=== Trace Information ==="
          for trace_file in test-results/*/trace.zip; do
            if [ -f "$trace_file" ]; then
              echo -e "\nAttempting to show trace: $trace_file"
              timeout 30 pnpm exec playwright show-trace "$trace_file" || echo "Trace viewing timed out"
            fi
          done

  test-component-snapshots:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.head_ref == 'changeset-release/main' || github.head_ref == 'main'
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2204
    container:
      image: scalarapi/playwright-runner:1.56.0
      options: --privileged
      env:
        VM_ID: ${{ env.VM_ID }}
        GITHUB_REPO_NAME: ${{ env.GITHUB_REPO_NAME }}
        BLACKSMITH_STICKYDISK_TOKEN: ${{ env.BLACKSMITH_STICKYDISK_TOKEN }}
        BLACKSMITH_INSTALLATION_MODEL_ID: ${{ env.BLACKSMITH_INSTALLATION_MODEL_ID }}
        BLACKSMITH_REGION: ${{ env.BLACKSMITH_REGION }}
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: '@scalar/components...'
      - name: Generate new DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV" && echo $DEPLOY_ID
      - name: Build storybook
        run: pnpm --filter components build:storybook
      - name: Run e2e tests (@scalar/components)
        run: pnpm --filter components test:e2e:ci
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Deploy Playwright Report to Netlify
        run: |
          pnpx netlify deploy --dir "./packages/components/playwright-report" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS_SNAPSHOTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --alias=${{env.DEPLOY_ID}}
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Add Netlify Playwright Report URL to the PR
        uses: daun/playwright-report-summary@93883773b4f4f0951d8bcdb780c6443ca51eaf7b # v3
        with:
          comment-title: 'Scalar Components Snapshot Test Results'
          report-url: https://${{env.DEPLOY_ID}}--scalar-snapshots.netlify.app
          report-file: packages/components/playwright-results.json
          report-tag: test-components-snapshots

  test-cdn-snapshots:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.head_ref == 'changeset-release/main' || github.head_ref == 'main'
    needs: [build]
    runs-on: blacksmith-8vcpu-ubuntu-2204
    container:
      image: scalarapi/playwright-runner:1.56.0
      options: --privileged
      env:
        VM_ID: ${{ env.VM_ID }}
        GITHUB_REPO_NAME: ${{ env.GITHUB_REPO_NAME }}
        BLACKSMITH_STICKYDISK_TOKEN: ${{ env.BLACKSMITH_STICKYDISK_TOKEN }}
        BLACKSMITH_INSTALLATION_MODEL_ID: ${{ env.BLACKSMITH_INSTALLATION_MODEL_ID }}
        BLACKSMITH_REGION: ${{ env.BLACKSMITH_REGION }}
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build packages
        uses: ./.github/actions/build
        with:
          packages: '@scalar/api-reference...'
      - name: Generate new DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV" && echo $DEPLOY_ID
      - name: Run snapshot tests (@scalar/api-reference)
        run: pnpm --filter api-reference test:e2e:cdn:ci
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Deploy Playwright Report to Netlify
        run: |
          pnpx netlify deploy --dir "./packages/api-reference/playwright-report-cdn" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS_SNAPSHOTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --alias=${{env.DEPLOY_ID}}
        # Only when the PR is from the same repository
      - if: ${{ !cancelled() && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]') }}
        name: Add Netlify Playwright Report URL to the PR
        uses: daun/playwright-report-summary@93883773b4f4f0951d8bcdb780c6443ca51eaf7b # v3
        with:
          comment-title: 'Scalar CDN Snapshot Diff Results'
          report-url: https://${{env.DEPLOY_ID}}--scalar-snapshots.netlify.app
          report-file: packages/api-reference/playwright-results-cdn.json
          report-tag: test-cdn-snapshots
          custom-info: These tests are **non-blocking** and will not prevent merging of your PR.
          footer: |
            > [!IMPORTANT]
            > These tests detect visual differences between the current PR and the latest CDN build which means **they may be affected by other changes in `main` that haven't been released yet**.
            >
            > They can help determine if the changes in the PR are causing any unexpected visual regressions but may be less helpful in isolating the exact cause. For more details see the [readme](https://github.com/scalar/scalar/blob/main/packages/api-reference/test-snapshots/README.md).

  # ---------------------------------------------------------------------------------------------------------
  # Publish and deploy packages

  # We use this job for automated changelog generation
  create-github-release:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 5
    permissions:
      contents: write
    needs: [required-jobs-main]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Generate release tag
        id: tag
        run: |
          DATE=$(date +%Y-%m-%d)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAG="release-${DATE}-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
      - name: Get PR body from merged release PR
        id: pr-body
        run: |
          # Find the PR that contains this commit
          PR_DATA=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/pulls --jq '.[0]')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body // ""')

          # Fallback if PR body is empty
          if [ -z "$PR_BODY" ] || [ "$PR_BODY" == "null" ]; then
            echo "PR body not found, using default notes"
            echo "Release ${{ steps.tag.outputs.date }}" > release-notes.md
          else
            # Extract only the relevant content:
            # - Start from "# Releases" heading
            # - Stop before "<!-- CURSOR_SUMMARY -->" marker
            echo "$PR_BODY" | awk '
              /^# Releases/ { found=1 }
              /<!-- CURSOR_SUMMARY -->/ { exit }
              found { print }
            ' > release-notes.md

            # If extraction failed (no "# Releases" found), use full body
            if [ ! -s release-notes.md ]; then
              echo "$PR_BODY" > release-notes.md
            fi
          fi
      - name: Create GitHub Release
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "Release ${{ steps.tag.outputs.date }}" \
            --notes-file release-notes.md

  npm-publish:
    if: github.ref == 'refs/heads/main'
    # Use a GitHub-hosted runner for npm publish to ensure signed releases
    runs-on: ${{ startsWith(github.event.head_commit.message, 'RELEASING:') && 'ubuntu-22.04' || 'blacksmith-4vcpu-ubuntu-2204' }}
    timeout-minutes: 15
    # Avoid running this job in parallel:
    # `changesets/action` creates/updates the release branch, which shouldn't happen in parallel.
    # npm publish also shouldn't happen in parallel.
    concurrency:
      group: npm-publish
      cancel-in-progress: false
    permissions:
      # Required for creating a release pull request
      contents: write
      pull-requests: write
      repository-projects: write
      # Required for npm provenance statements
      id-token: write
    needs: [required-jobs-main]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build
        uses: ./.github/actions/build
        with:
          # Build everything
          packages: './**'
      - name: Git Status
        run: git status
      - name: Stash changes
        run: git stash
      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba # v1
        with:
          # The pull request title.
          title: 'chore: release'
          # The command to update version, edit CHANGELOG, read and delete changesets.
          version: 'pnpm changeset version'
          # The commit message to use.
          commit: 'chore: version packages'
          # The command to use to build and publish packages
          publish: 'pnpm -r publish --access public'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # https://www.npmjs.com/settings/YOUR_ACCOUNT_HANDLE/tokens/granular-access-tokens/new
          # Custom Expiration: 01-01-2100
          # Permissions: Read and Write
          # Select packages: @scalar
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Bust CDN cache
        if: steps.changesets.outputs.published == 'true'
        uses: fjogeleit/http-request-action@23ad54bcd1178fcff6a0d17538fa09de3a7f0a4d # v1.16.4
        with:
          url: 'https://purge.jsdelivr.net/npm/@scalar/api-reference'
          method: 'GET'

  todesktop-build:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, test-packages]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './{packages,integrations,projects}/**'
      - name: Git Status
        run: git status
      - name: Stash changes
        run: git stash
      - name: Check whether appFiles are there
        run: ls -R ./projects/scalar-app/dist
      - if: startsWith(github.event.head_commit.message, 'RELEASING:')
        name: Check whether there's a new version of the app
        id: changed-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            api_client_app:
              - projects/scalar-app/package.json
      - if: steps.changed-files.outputs.api_client_app_any_changed == 'true'
        name: Check whether appFiles are there
        run: ls -R ./projects/scalar-app/dist
      - if: steps.changed-files.outputs.api_client_app_any_changed == 'true'
        name: Build in the toDesktop cloud
        run: pnpm --filter scalar-app todesktop:build:ci
        env:
          TODESKTOP_EMAIL: ${{ secrets.TODESKTOP_EMAIL }}
          TODESKTOP_ACCESS_TOKEN: ${{ secrets.TODESKTOP_ACCESS_TOKEN }}

  deploy-api-client:
    # Only run this job for PRs from the same repository
    if: github.ref == 'refs/heads/main' || github.event.pull_request.head.repo.full_name == github.repository
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Check which files were touched
        id: changed-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            api_client:
              - projects/client-scalar-com/**
              - packages/api-client/**
      - if: steps.changed-files.outputs.api_client_any_changed == 'true'
        name: Build
        uses: ./.github/actions/build
        with:
          packages: 'client-scalar-com...'
      - if: steps.changed-files.outputs.api_client_any_changed == 'true'
        name: Deploy to client.staging.scalar.com (staging)
        id: deploy-client-staging
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: pages deploy dist --project-name=client-staging
          workingDirectory: projects/client-scalar-com
          # 1) Log in to the Cloudflare dashboard.
          # 2) Select Workers & Pages.
          # 3) See the Account ID in the right sidebar.
          # Read more: https://developers.cloudflare.com/fundamentals/setup/find-account-and-zone-ids/
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # 1) Go to https://dash.cloudflare.com/profile/api-tokens
          # 2) Create a token with the following permissions:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      - if: github.ref != 'refs/heads/main' && steps.deploy-client-staging.outputs.deployment-url
        name: Add Cloudflare Preview URL to the PR
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: |
            **Cloudflare Preview for the API Client**

            ${{ steps.deploy-client-staging.outputs.deployment-url }}
          comment-tag: 'cloudflare-preview'
      - if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
        name: Check for new @scalar/api-client version
        id: client-version
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            api_client:
              - packages/api-client/**
      - if: steps.client-version.outputs.api_client_any_changed == 'true'
        name: Deploy to client.scalar.com (production)
        id: deploy-client-production
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: pages deploy dist --project-name=client
          workingDirectory: projects/client-scalar-com
          # 1) Log in to the Cloudflare dashboard.
          # 2) Select Workers & Pages.
          # 3) See the Account ID in the right sidebar.
          # Read more: https://developers.cloudflare.com/fundamentals/setup/find-account-and-zone-ids/
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # 1) Go to https://dash.cloudflare.com/profile/api-tokens
          # 2) Create a token with the following permissions:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  push-to-scalar-registry:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, test-packages]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Build @scalar/galaxy
        uses: ./.github/actions/build
        with:
          packages: '@scalar/galaxy...'
      - name: Check whether there's a new version of @scalar/galaxy
        id: changed-files
        uses: step-security/changed-files@60967b822d3001fa82242f8d6b4ed46bc3600a68 # v47
        with:
          files_yaml: |
            galaxy:
              - packages/galaxy/**
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Get version from package.json
        id: package-version
        working-directory: packages/galaxy
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Login to Scalar Registry
        run: npx @scalar/cli@latest auth login --token ${{ secrets.SCALAR_API_KEY }}
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Push OpenAPI Example to Scalar Registry
        run: npx @scalar/cli@latest registry publish --namespace scalar --slug galaxy --version ${{ steps.package-version.outputs.VERSION }} packages/galaxy/dist/latest.yaml
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Push AsyncAPI Example to Scalar Registry
        # We're uploading it as a schema, because for documents do not support AsyncAPI yet.
        run: npx @scalar/cli@latest schema publish --namespace scalar --slug asyncapi --version ${{ steps.package-version.outputs.VERSION }} packages/galaxy/dist/asyncapi/latest.yaml

  deploy-api-reference:
    # Run only for PRs from the same repository
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]')
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: deploy-api-reference-${{ github.ref }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}
    outputs:
      preview-url: ${{ steps.set-output.outputs.url }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Build
        uses: ./.github/actions/build
        with:
          packages: '@scalar-examples/web...'

      - name: Generate DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV"

      - name: Install Netlify CLI
        run: pnpm install -g netlify

      - name: Deploy to Netlify
        run: |
          netlify deploy --dir "./examples/web/dist" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_PREVIEW }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar-examples/web \
            --alias=${{env.DEPLOY_ID}}

      - name: Set output
        id: set-output
        if: github.event_name == 'pull_request'
        run: echo "url=https://${{ env.DEPLOY_ID }}--scalar-deploy-preview.netlify.app" >> $GITHUB_OUTPUT

  deploy-components:
    # Run for PRs (preview) or main branch (production)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]')) ||
      github.ref == 'refs/heads/main'
    needs: [build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: deploy-components-${{ github.ref }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}
    outputs:
      preview-url: ${{ steps.set-output.outputs.url }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './packages/**'

      - name: Generate DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV"

      - name: Install Netlify CLI
        run: pnpm install -g netlify

      - name: Build storybook
        run: pnpm --filter components build:storybook

      - name: Deploy Storybook to Netlify (Preview)
        if: github.event_name == 'pull_request'
        run: |
          netlify deploy --dir "./packages/components/storybook-static" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --alias=${{env.DEPLOY_ID}}

      - name: Deploy Storybook to Netlify (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          netlify deploy --dir "./packages/components/storybook-static" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --prod

      - name: Set output
        id: set-output
        if: github.event_name == 'pull_request'
        run: echo "url=https://${{ env.DEPLOY_ID }}--scalar-components.netlify.app" >> $GITHUB_OUTPUT

  galaxy-registry-preview:
    # Only run for PRs from the same repository
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !contains(github.actor, '[bot]') &&
      needs.check-changes.outputs.galaxy_changed == 'true'
    needs: [build, check-changes]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    outputs:
      preview-url: ${{ steps.set-preview-url.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Build @scalar/galaxy
        uses: ./.github/actions/build
        with:
          packages: '@scalar/galaxy...'

      - name: Extract version and generate preview version
        id: preview-version
        working-directory: packages/galaxy
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BRANCH_NAME=$(echo "$GITHUB_HEAD_REF" | sed 's/[^a-zA-Z0-9-]/-/g')
          PREVIEW_VERSION="${VERSION}-${BRANCH_NAME}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "PREVIEW_VERSION=$PREVIEW_VERSION" >> $GITHUB_ENV
          echo "version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT

      - name: Login to Scalar Registry
        run: npx @scalar/cli@latest auth login --token ${{ secrets.SCALAR_API_KEY }}

      - name: Publish preview version to Scalar Registry
        run: npx @scalar/cli@latest --version && npx @scalar/cli@latest registry publish --namespace scalar --slug galaxy --version ${{ env.PREVIEW_VERSION }} --force --no-current packages/galaxy/dist/latest.yaml

      - name: Set preview URL output
        id: set-preview-url
        run: echo "url=https://registry.scalar.com/@scalar/apis/galaxy/${{ env.PREVIEW_VERSION }}" >> $GITHUB_OUTPUT

  preview-comment:
    # Only run for PRs from the same repository
    if: |
      always() &&
      (needs.deploy-api-reference.result == 'success' ||
       needs.deploy-components.result == 'success' ||
       needs.galaxy-registry-preview.result == 'success') &&
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !contains(github.actor, '[bot]')
    needs: [deploy-api-reference, deploy-components, galaxy-registry-preview]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 5
    permissions:
      pull-requests: write
    steps:
      - name: Build comment message
        id: build-message
        run: |
          MESSAGE=""

          if [ "${{ needs.deploy-api-reference.result }}" == "success" ]; then
            MESSAGE="$MESSAGE**Preview Examples**

          ${{ needs.deploy-api-reference.outputs.preview-url }}

          "
          fi

          if [ "${{ needs.deploy-components.result }}" == "success" ]; then
            MESSAGE="$MESSAGE**Preview Storybook**

          ${{ needs.deploy-components.outputs.preview-url }}

          "
          fi

          if [ "${{ needs.galaxy-registry-preview.result }}" == "success" ]; then
            MESSAGE="$MESSAGE**Scalar Registry Preview**

          ${{ needs.galaxy-registry-preview.outputs.preview-url }}

          "
          fi

          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add combined preview URLs to the PR
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: ${{ steps.build-message.outputs.message }}
          comment-tag: 'deployment-preview'

  # ---------------------------------------------------------------------------------------------------------
  # Integration builds, tests, and publishes

  docker-build-scan:
    if: needs.check-changes.outputs.docker_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/docker/assets

      - name: Compress static assets
        working-directory: integrations/docker/assets
        run: gzip --keep --verbose --force scalar.js

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@33fed32c1ba8775f20366ec9e8d0cd9fe8fc1dd3 # v1
        with:
          platforms: linux/amd64

      - name: Build Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/docker
          file: integrations/docker/Dockerfile
          load: true
          tags: scalarapi/api-reference:latest

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: 'image'
          image-ref: 'scalarapi/api-reference:latest'
          format: 'table'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  docker-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.docker_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: docker-publish
      cancel-in-progress: false
    needs: [required-jobs-main, docker-build-scan, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/docker
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/docker/assets

      - name: Compress static assets
        working-directory: integrations/docker/assets
        run: gzip --keep --verbose --force scalar.js

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@33fed32c1ba8775f20366ec9e8d0cd9fe8fc1dd3 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Log in to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          # Username of your Docker account
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          # https://app.docker.com/settings/personal-access-tokens
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/docker
          file: integrations/docker/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            scalarapi/api-reference:latest
            scalarapi/api-reference:${{ steps.package-version.outputs.VERSION }}

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: scalarapi/api-reference
          readme-filepath: ./integrations/docker/README.md

  mock-server-docker-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.mock_server_docker_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: mock-server-docker-publish
      cancel-in-progress: false
    needs: [required-jobs-main, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Get version from package.json
        id: package-version
        working-directory: packages/mock-server/docker
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Download mock server docker entrypoint artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: mock-server-docker-entrypoint
          path: packages/mock-server/docker/dist/

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@33fed32c1ba8775f20366ec9e8d0cd9fe8fc1dd3 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Log in to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: packages/mock-server/docker
          file: packages/mock-server/docker/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            scalarapi/mock-server:latest
            scalarapi/mock-server:${{ steps.package-version.outputs.VERSION }}

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: scalarapi/mock-server
          readme-filepath: ./packages/mock-server/docker/README.md

  dotnet-build-test:
    if: needs.check-changes.outputs.dotnet_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: temp-assets

      - name: Copy scalar.js to aspnetcore and aspire
        run: |
          cp temp-assets/scalar.js integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets/
          cp temp-assets/scalar.js integrations/dotnet/aspire/src/Scalar.Aspire.Service/wwwroot/

      - name: Compress static assets (aspnetcore)
        working-directory: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets
        run: gzip --keep --verbose --force scalar.js scalar.aspnetcore.js favicon.svg

      - name: Cache NuGet packages
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: fast-actions/setup-dotnet@e93bbf6e68255c6a085279c473bec0f02bda8cfb # v1
        with:
          sdk-version: 10.x.x
          aspnetcore-version: |
            9.x.x
            8.x.x

      - name: Restore dependencies
        working-directory: integrations/dotnet
        run: dotnet restore

      - name: Build solution
        working-directory: integrations/dotnet
        run: dotnet build -c Release --no-restore

      - name: Test solution
        working-directory: integrations/dotnet
        run: dotnet test -c Release --no-build

  aspnetcore-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.aspnetcore_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    # We don't want to run `nuget push` (publishing to NuGet) in parallel.
    concurrency:
      group: aspnetcore-publish
      cancel-in-progress: false
    needs: [required-jobs-main, dotnet-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Git Status
        run: git status

      - name: Stash changes
        run: git stash

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/dotnet/aspnetcore
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets

      - name: Compress static assets
        working-directory: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets
        run: gzip --keep --verbose --force scalar.js scalar.aspnetcore.js favicon.svg

      - name: Cache NuGet packages
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: fast-actions/setup-dotnet@e93bbf6e68255c6a085279c473bec0f02bda8cfb # v1
        with:
          sdk-version: 10.x.x

      - name: Restore dependencies
        working-directory: integrations/dotnet/aspnetcore
        run: dotnet restore

      - name: Pack packages
        working-directory: integrations/dotnet/aspnetcore
        run: |
          dotnet pack src/Scalar.AspNetCore -c Release --no-restore --output nupkgs /p:Version=${{ steps.package-version.outputs.VERSION }}
          dotnet pack src/Scalar.AspNetCore.Microsoft -c Release --no-restore --output nupkgs /p:Version=${{ steps.package-version.outputs.VERSION }}
          dotnet pack src/Scalar.AspNetCore.Swashbuckle -c Release --no-restore --output nupkgs /p:Version=${{ steps.package-version.outputs.VERSION }}

      - name: Publish packages
        working-directory: integrations/dotnet/aspnetcore
        run: dotnet nuget push nupkgs/*.nupkg -k ${{ secrets.NUGET_TOKEN }} -s https://api.nuget.org/v3/index.json

  aspire-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.aspire_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: aspire-publish
      cancel-in-progress: false
    needs: [required-jobs-main, dotnet-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Git Status
        run: git status

      - name: Stash changes
        run: git stash

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/dotnet/aspire
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/dotnet/aspire/src/Scalar.Aspire.Service/wwwroot

      - name: Log in to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@33fed32c1ba8775f20366ec9e8d0cd9fe8fc1dd3 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Build and push Aspire Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/dotnet
          file: integrations/dotnet/aspire/src/Scalar.Aspire.Service/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            scalarapi/aspire-api-reference:latest
            scalarapi/aspire-api-reference:${{ steps.package-version.outputs.VERSION }}

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: scalarapi/aspire-api-reference
          readme-filepath: ./integrations/dotnet/aspire/README.md

      - name: Set version in Constants.cs
        working-directory: integrations/dotnet/aspire

        run: |
          sed -i 's/ImageTag = "latest"/ImageTag = "'${{ steps.package-version.outputs.VERSION }}'"/' src/Scalar.Aspire/Constants.cs
          cat src/Scalar.Aspire/Constants.cs

      - name: Cache NuGet packages
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: fast-actions/setup-dotnet@e93bbf6e68255c6a085279c473bec0f02bda8cfb # v1
        with:
          sdk-version: 10.x.x

      - name: Restore dependencies
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet restore

      - name: Pack Scalar.Aspire NuGet package
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet pack -c Release --no-restore --output nupkgs /p:Version=${{ steps.package-version.outputs.VERSION }}

      - name: Publish Scalar.Aspire NuGet package
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet nuget push nupkgs/*.nupkg -k ${{ secrets.NUGET_TOKEN }} -s https://api.nuget.org/v3/index.json

  fastapi-build-test:
    if: needs.check-changes.outputs.fastapi_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/fastapi
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build Python package
        working-directory: integrations/fastapi
        run: python -m build

      - name: Run tests
        working-directory: integrations/fastapi
        run: python run_tests.py

  fastapi-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.fastapi_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: fastapi-publish
      cancel-in-progress: false
    needs: [required-jobs-main, fastapi-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/fastapi
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build FastAPI package
        working-directory: integrations/fastapi
        run: python -m build

      - name: Publish FastAPI package to PyPI
        working-directory: integrations/fastapi
        run: |
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*

  django-ninja-build-test:
    if: needs.check-changes.outputs.django_ninja_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/django-ninja
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build Python package
        working-directory: integrations/django-ninja
        run: python -m build

      - name: Run tests
        working-directory: integrations/django-ninja
        run: python run_tests.py

  django-ninja-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.django_ninja_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: django-ninja-publish
      cancel-in-progress: false
    needs: [required-jobs-main, django-ninja-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/django-ninja
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Django Ninja package
        working-directory: integrations/django-ninja
        run: python -m build

      - name: Publish Django Ninja package to PyPI
        working-directory: integrations/django-ninja
        run: |
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*

  rust-build-test:
    if: needs.check-changes.outputs.rust_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/rust/ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check Rust code formatting
        working-directory: integrations/rust
        run: cargo fmt -- --check

      - name: Run Clippy
        working-directory: integrations/rust
        run: cargo clippy -- -D warnings

      - name: Run tests
        working-directory: integrations/rust
        run: cargo test

      - name: Run tests with all features
        working-directory: integrations/rust
        run: cargo test --features axum,actix-web,warp

      - name: Build examples
        working-directory: integrations/rust
        run: |
          cargo build --example axum --features axum
          cargo build --example actix --features actix-web
          cargo build --example warp --features warp

  rust-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.rust_package_changed == 'true'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 10
    concurrency:
      group: rust-publish
      cancel-in-progress: false
    needs: [required-jobs-main, rust-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/rust/ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/rust
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Update Cargo.toml version
        working-directory: integrations/rust
        env:
          VERSION: ${{ steps.package-version.outputs.VERSION }}
        run: |
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          cat Cargo.toml | grep version

      - name: Publish to crates.io
        working-directory: integrations/rust
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  java-build-test:
    if: needs.check-changes.outputs.java_changed == 'true'
    needs: [build, check-changes]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/java/scalar-core/src/main/resources/META-INF/resources/webjars/scalar
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          cache-dependency-path: 'integrations/java/**/pom.xml'
      - name: Run Maven tests
        working-directory: integrations/java
        run: mvn clean test

  java-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.java_package_changed == 'true'
    needs: [required-jobs-main, java-build-test, check-changes]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    concurrency:
      group: java-publish
      cancel-in-progress: false
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Download scalar.js artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: scalar-js
          path: integrations/java/scalar-core/src/main/resources/META-INF/resources/webjars/scalar
      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          cache-dependency-path: '**/java/pom.xml'
          server-id: 'central'
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/java
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"
      - name: Set version in parent POM
        working-directory: integrations/java
        run: mvn versions:set -DnewVersion=${{ steps.package-version.outputs.VERSION }} -DgenerateBackupPoms=false
      - name: Build all Java modules
        working-directory: integrations/java
        run: mvn clean package -pl scalar-core,scalar-webmvc,scalar-webflux -am
      - name: Publish all Java modules to Maven Central
        working-directory: integrations/java
        run: mvn deploy -pl scalar-core,scalar-webmvc,scalar-webflux -am
        env:
          # Create an account on Sonatype and add the credentials to the repository secrets.
          # Generate User Token: https://central.sonatype.com/account
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_KEYNAME: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
  # ---------------------------------------------------------------------------------------------------------
  # Other jobs

  required-jobs-pull-requests:
    if: github.event_name == 'pull_request'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 1
    permissions: {}
    needs:
      [
        build,
        format,
        knip,
        test-packages,
        test-integrations,
        test-proxy-server,
        types,
      ]
    steps:
      - name: Exit with error if some jobs are not successful
        run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'skipped') || contains(needs.*.result, 'cancelled')) }}

  required-jobs-main:
    if: github.ref == 'refs/heads/main'
    runs-on: blacksmith-2vcpu-ubuntu-2204
    timeout-minutes: 1
    permissions: {}
    needs: [build, test-packages, test-integrations, test-proxy-server, types]
    steps:
      - name: Exit with error if some jobs are not successful
        run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'skipped') || contains(needs.*.result, 'cancelled')) }}
